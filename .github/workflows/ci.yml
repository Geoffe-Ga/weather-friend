name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  PYTHON_DEFAULT_VERSION: "3.12"
  COVERAGE_THRESHOLD: 90
  BRANCH_COVERAGE_THRESHOLD: 85
  MUTATION_SCORE_THRESHOLD: 80
  DOCSTRING_COVERAGE_THRESHOLD: 95

jobs:
  quality:
    name: Quality Checks (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements*.txt', '**/setup.py', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install pytest pytest-cov pytest-xdist
          pip install ruff pylint mypy
          pip install bandit pip-audit
          pip install interrogate
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          if [ -f setup.py ]; then pip install -e .; fi
          if [ -f pyproject.toml ]; then pip install -e .; fi

      - name: Run Ruff linter
        run: |
          ruff check . --output-format=github
        continue-on-error: false

      - name: Run Ruff formatter check
        run: |
          ruff format --check .
        continue-on-error: false

      - name: Run Pylint
        run: |
          pylint **/*.py --exit-zero --output-format=colorized --reports=y
        continue-on-error: false

      - name: Run MyPy type checking
        run: |
          mypy . --install-types --non-interactive --ignore-missing-imports --show-error-codes
        continue-on-error: false

      - name: Check docstring coverage
        run: |
          interrogate -v --fail-under=${{ env.DOCSTRING_COVERAGE_THRESHOLD }} .
        continue-on-error: false

      - name: Run Bandit security scan
        run: |
          bandit -r . -f json -o bandit-report.json --exclude .venv || true
          bandit -r . -f screen --exclude .venv || true
          python -c "import json; report=json.load(open('bandit-report.json')); high_severity=[i for i in report['results'] if i['issue_severity'] in ['HIGH', 'CRITICAL']]; exit(1 if high_severity else 0)"
        continue-on-error: false

      - name: Run pip-audit for dependency vulnerabilities
        run: |
          pip-audit --desc --format json --output pip-audit-report.json || true
          pip-audit --desc || true
          python -c "import json; report=json.load(open('pip-audit-report.json')); critical=[v for v in report.get('dependencies', []) for vuln in v.get('vulns', []) if vuln.get('severity', '').upper() in ['HIGH', 'CRITICAL']]; exit(1 if critical else 0)"
        continue-on-error: false

      - name: Run tests with coverage
        run: |
          pytest --cov=. --cov-report=xml --cov-report=html --cov-report=term-missing --cov-branch --cov-fail-under=${{ env.COVERAGE_THRESHOLD }} -n auto -v
        continue-on-error: false

      - name: Check branch coverage threshold
        run: |
          python -c "import xml.etree.ElementTree as ET; tree=ET.parse('coverage.xml'); root=tree.getroot(); branch_rate=float(root.attrib.get('branch-rate', 0))*100; print(f'Branch coverage: {branch_rate:.2f}%'); exit(0 if branch_rate >= ${{ env.BRANCH_COVERAGE_THRESHOLD }} else 1)"
        continue-on-error: false

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: python-${{ matrix.python-version }}
          name: coverage-${{ matrix.python-version }}
          fail_ci_if_error: false

      - name: Upload coverage reports as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ matrix.python-version }}
          path: |
            coverage.xml
            htmlcov/
          retention-days: 30

      - name: Upload security reports as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ matrix.python-version }}
          path: |
            bandit-report.json
            pip-audit-report.json
          retention-days: 30

  mutation-testing:
    name: Mutation Testing
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_DEFAULT_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-mutation-${{ hashFiles('**/requirements*.txt', '**/setup.py', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-mutation-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install mutmut pytest
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          if [ -f setup.py ]; then pip install -e .; fi
          if [ -f pyproject.toml ]; then pip install -e .; fi

      - name: Run mutation testing
        run: |
          mutmut run --paths-to-mutate=. --tests-dir=tests || true
          mutmut results
          mutmut junitxml > mutation-report.xml
          MUTATION_SCORE=$(mutmut results | grep -oP 'survived: \K\d+' | head -1 || echo "0")
          TOTAL_MUTATIONS=$(mutmut results | grep -oP 'total: \K\d+' | head -1 || echo "1")
          MUTATION_PERCENTAGE=$((100 - (MUTATION_SCORE * 100 / TOTAL_MUTATIONS)))
          echo "Mutation score: ${MUTATION_PERCENTAGE}%"
          if [ $MUTATION_PERCENTAGE -lt ${{ env.MUTATION_SCORE_THRESHOLD }} ]; then
            echo "Mutation score ${MUTATION_PERCENTAGE}% is below threshold ${{ env.MUTATION_SCORE_THRESHOLD }}%"
            exit 1
          fi
        continue-on-error: false

      - name: Upload mutation testing report
        uses: actions/upload-artifact@v4
        with:
          name: mutation-report
          path: mutation-report.xml
          retention-days: 30

  complexity-analysis:
    name: Code Complexity Analysis
    runs-on: ubuntu-latest
    needs: quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_DEFAULT_VERSION }}

      - name: Install analysis tools
        run: |
          python -m pip install --upgrade pip
          pip install radon xenon

      - name: Run cyclomatic complexity analysis
        run: |
          radon cc . -a -s

      - name: Run maintainability index
        run: |
          radon mi . -s

      - name: Check complexity thresholds
        run: |
          xenon --max-absolute B --max-modules B --max-average A . || true

  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_DEFAULT_VERSION }}

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: |
          python -m build

      - name: Check package with twine
        run: |
          twine check dist/*

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-package
          path: dist/
          retention-days: 30